-- blocking_pairs.sql.j2
-- Generates all unique company_id_a, company_id_b pairs across all block kinds
-- Parameters:
--   blocks_table   : table containing (kind, bkey, company_id)
--   pairs_table    : target table name for output

CREATE OR REPLACE TABLE {{ pairs_table }} AS
WITH base AS (
  -- De-dup within each (kind, bkey) to keep only unique company_ids
  SELECT DISTINCT kind, bkey, company_id
  FROM {{ blocks_table }}
),
pairs AS (
  SELECT
    a.kind AS kind,
    a.bkey AS bkey,
    a.company_id AS company_id_a,
    b.company_id AS company_id_b
  FROM base a
  JOIN base b
    ON a.kind = b.kind
   AND a.bkey = b.bkey
   AND b.company_id > a.company_id
),
dedup AS (
  SELECT DISTINCT kind, bkey, company_id_a, company_id_b
  FROM pairs
)
SELECT * FROM dedup;