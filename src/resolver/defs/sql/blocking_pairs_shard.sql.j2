-- blocking_pairs_shard.sql.j2
-- helper expression: choose existing hash col or compute from kind|bkey
{% if bkey_hash_col %}
  {% set HASH_EXPR = bkey_hash_col %}
{% else %}
  {% set HASH_EXPR = "hash(kind || '|' || bkey)" %}
{% endif %}


{% if shard_table %}
CREATE OR REPLACE TABLE {{ shard_table }} AS
{% endif %}
WITH shard AS (
  SELECT DISTINCT kind, bkey, company_id
  FROM {{ blocks_table }}
  WHERE ((({{ HASH_EXPR }}) & 9223372036854775807) % {{ shard_modulus }}) = {{ shard_index }}
),
pairs AS (
  SELECT DISTINCT
    a.company_id AS company_id_a,
    b.company_id AS company_id_b
  FROM shard a
  JOIN shard b
    ON a.kind = b.kind
   AND a.bkey = b.bkey
   AND b.company_id > a.company_id
),
dedup as (
  SELECT DISTINCT company_id_a, company_id_b FROM pairs
)
,ranked AS (
  SELECT
    company_id_a, company_id_b,
    ROW_NUMBER() OVER (PARTITION BY company_id_a ORDER BY company_id_b) AS rn
  FROM dedup
)
--could be sketchy - we are ranking within a shard so might be boundary issues here
SELECT DISTINCT company_id_a, company_id_b
FROM ranked
WHERE rn <= {{ cap_per_a }};
